/* BackgroundCheck
   http://kennethcachia.com/background-check
   v1.1.2 */

!function(a,b){"function"==typeof define&&define.amd?define(b):a.BackgroundCheck=b(a)}(this,function(){"use strict";function a(a){if(void 0===a||void 0===a.targets)throw"Missing attributes";A.targets=f(a.targets),A.images=f(a.images||"img"),A.changeParent=d(a.changeParent,!1),A.threshold=d(a.threshold,50),A.minComplexity=d(a.minComplexity,30),A.minOverlap=d(a.minOverlap,50),A.windowEvents=d(a.windowEvents,!0),A.maxDuration=d(a.maxDuration,500),A.debug=d(a.debug,!1),A.mask=d(a.mask,{r:0,g:255,b:0}),A.classes=d(a.classes,{dark:"background--dark",light:"background--light",complex:"background--complex"}),void 0===u&&(g(),u&&(v.style.position="fixed",v.style.top="0px",v.style.left="0px",v.style.width="100%",v.style.height="100%",window.addEventListener(z,r.bind(null,function(){i(),q()})),window.addEventListener("scroll",r.bind(null,q)),i(),q()))}function b(){u=null,v=null,w=null,A={},x&&clearTimeout(x)}function c(a){t("debug")&&console.log(a)}function d(a,b){return e(a,typeof b),void 0===a?b:a}function e(a,b){if(void 0!==a&&typeof a!==b)throw"Incorrect attribute type"}function f(a){var b=a;if("string"==typeof a?b=document.querySelectorAll(a):a&&1===a.nodeType&&(b=[a]),!b||0===b.length||void 0===b.length)throw"Elements not found";return b=Array.prototype.slice.call(b)}function g(){v=document.createElement("canvas"),v&&v.getContext?(w=v.getContext("2d"),u=!0):u=!1}function h(a){var d=(new Date).getTime()-a;c("Duration: "+d+"ms"),d>t("maxDuration")&&(console.log("BackgroundCheck - Killed"),k(),b())}function i(){y={left:0,top:0,right:document.body.clientWidth,bottom:window.innerHeight},v.width=document.body.clientWidth,v.height=window.innerHeight}function j(a){var b=a.getBoundingClientRect();w.drawImage(a,b.left,b.top,b.width,b.height)}function k(a){for(var b,c=a?[a]:t("targets"),d=0;d<c.length;d++)b=c[d],b=t("changeParent")?b.parentNode:b,b.classList.remove(t("classes").light),b.classList.remove(t("classes").dark),b.classList.remove(t("classes").complex)}function l(a){var b,d,e,f,g=a.getBoundingClientRect(),h=0,i=0,j=0,l=0,m=t("mask");if(g.width>0&&g.height>0){k(a),a=t("changeParent")?a.parentNode:a,d=w.getImageData(g.left,g.top,g.width,g.height).data;for(var n=0;n<d.length;n+=4)d[n]===m.r&&d[n+1]===m.g&&d[n+2]===m.b?l++:(h++,b=.2126*d[n]+.7152*d[n+1]+.0722*d[n+2],e=b-j,i+=e*e,j+=e/h);l<=d.length/4*(1-t("minOverlap")/100)&&(f=Math.sqrt(i/h)/255,j/=255,c("Target: "+a.className+" lum: "+j+" var: "+f),a.classList.add(j<=t("threshold")/100?t("classes").dark:t("classes").light),f>t("minComplexity")/100&&a.classList.add(t("classes").complex))}}function m(a,b){return a=a.getBoundingClientRect(),b=b===y?b:b.getBoundingClientRect(),!(a.right<b.left||a.left>b.right||a.top>b.bottom||a.bottom<b.top)}function n(a){for(var b,c=(new Date).getTime(),d=a&&"IMG"===a.tagName?"image":"targets",e=a?!1:!0,f=t("targets").length,g=0;f>g;g++)b=t("targets")[g],m(b,y)&&("targets"!==d||a&&a!==b?"image"===d&&m(b,a)&&l(b):(e=!0,l(b)));if("targets"===d&&!e)throw a+" is not a target";h(c)}function o(a){var b,c,d=a.parentNode,e=function(a){var b=0;return"static"!==window.getComputedStyle(a).position&&(b=parseInt(window.getComputedStyle(a).zIndex,10)||0,b>=0&&b++),b};return c=d?e(d):0,b=e(a),1e5*c+b}function p(a){var b=!1;return a.sort(function(a,c){var d=a.compareDocumentPosition(c),e=0;return a=o(a),c=o(c),a>c&&(b=!0),a===c&&2===d?e=1:a===c&&4===d&&(e=-1),e||a-c}),c("Sorted: "+b),b&&c(a),b}function q(a,b,d){var e,f,g=!1,h=t("mask"),i=d?[d]:t("images");if(c("--- BackgroundCheck ---"),c("onLoad event: "+(d&&d.src)),u){b!==!0&&(w.clearRect(0,0,v.width,v.height),w.fillStyle="rgb("+h.r+", "+h.g+", "+h.b+")",w.fillRect(0,0,v.width,v.height)),f=p(i);for(var k=0;k<i.length;k++)e=i[k],m(e,y)&&(0===e.naturalWidth?(g=!0,c("Loading... "+e.src),e.removeEventListener("load",q),f?e.addEventListener("load",q.bind(null,null,!1,null)):e.addEventListener("load",q.bind(null,a,!0,e))):(c("Drawing: "+e.src),j(e)));d||g?d&&n(d):n(a)}}function r(a){t("windowEvents")===!0&&(x&&clearTimeout(x),x=setTimeout(a,200))}function s(a,b){if(void 0===A[a])throw"Unknown property - "+a;if(void 0===b)throw"Missing value for "+a;if("targets"===a||"images"===a)try{b=f("images"!==a||b?b:"img")}catch(c){throw b=[],c}else e(b,typeof A[a]);k(),A[a]=b,q()}function t(a){if(void 0===A[a])throw"Unknown property - "+a;return A[a]}var u,v,w,x,y,z=void 0!==window.orientation?"orientationchange":"resize",A={};return{init:a,destroy:b,refresh:q,set:s,get:t}});